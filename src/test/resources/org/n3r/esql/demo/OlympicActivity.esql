-- 随机获取一种奖项（排除参与奖）
[GetRandomAwardType]
SELECT * FROM (
    SELECT /*+ FRIST_ROWS(10) */ DBMS_RANDOM.VALUE(1,10) RANDOM,
           C.AWARD_ID, C.AWARD_TYPE, C.AWARD_PROB, C.AWARD_LUCK_NUM,
           C.TOTAL_NUM, C.REMAIN_NUM, C.IS_DEFAULT_AWARD, 
           C.AWARD_GOODS_DESC, C.AWARD_GOODS_CODE
    FROM  TD_B_AWARD_CONFIG C
    WHERE C.AWARD_TYPE != '4'
    AND   C.BEGIN_TM < SYSDATE
    AND   C.END_TM > SYSDATE
    ORDER BY 1
) WHERE ROWNUM <= 1

    
-- 获取默认奖项
[GetDefaultAward]
SELECT C.AWARD_ID, C.AWARD_TYPE, C.AWARD_PROB, C.AWARD_LUCK_NUM, 
       C.TOTAL_NUM, C.REMAIN_NUM, C.IS_DEFAULT_AWARD, 
       C.AWARD_GOODS_DESC, C.AWARD_GOODS_CODE
FROM   TD_B_AWARD_CONFIG C
WHERE  C.IS_DEFAULT_AWARD = 1
AND    C.BEGIN_TM < SYSDATE
AND    C.END_TM > SYSDATE
AND    ROWNUM <= 1

    
-- 获取指定类型的奖项
[GetTypeAward]
SELECT C.AWARD_ID, C.AWARD_TYPE, C.AWARD_PROB, C.AWARD_LUCK_NUM, 
       C.TOTAL_NUM, C.REMAIN_NUM, C.IS_DEFAULT_AWARD, 
       C.AWARD_GOODS_DESC, C.AWARD_GOODS_CODE
FROM   TD_B_AWARD_CONFIG C
WHERE  C.AWARD_TYPE = #AWARD_TYPE#
AND    C.BEGIN_TM < SYSDATE
AND    C.END_TM > SYSDATE
AND    ROWNUM <= 1

-- 奖项剩余数量递减
[DecreaseAwardRemain]
UPDATE TD_B_AWARD_CONFIG C
SET    C.REMAIN_NUM = C.REMAIN_NUM -1
WHERE  C.AWARD_ID = #AWARD_ID#
AND    C.REMAIN_NUM > 0

-- 记录抽奖信息
[RecordAwardOrder]
INSERT INTO TF_B_AWARD_ORDER 
(LOG_ID, CUST_ID, LOGIN_NAME, CUST_IP, CREATE_TIME, AWARD_ID, 
 AWARD_TYPE, AWARD_GOODS_DESC, AWARD_STATUS, AWARD_NUMBER
)
VALUES
(F_SYS_GETSEQID('SEQ_ORDER_ID'), #CUST_ID#, #LOGIN_NAME#, #CUST_IP#, SYSDATE, #AWARD_ID#, 
 #AWARD_TYPE#, #AWARD_GOODS_DESC#, '0', #AWARD_NUMBER#
)

-- 记录抽奖（限制奖）信息
[RecordAwardOrderWithLimit]
INSERT INTO TF_B_AWARD_ORDER 
(LOG_ID, CUST_ID, LOGIN_NAME, CUST_IP, CREATE_TIME, AWARD_ID, 
 AWARD_TYPE, AWARD_GOODS_DESC, AWARD_STATUS, AWARD_NUMBER
)
SELECT F_SYS_GETSEQID('SEQ_ORDER_ID'), #CUST_ID#, #LOGIN_NAME#, #CUST_IP#, SYSDATE, #AWARD_ID#, 
       #AWARD_TYPE#, #AWARD_GOODS_DESC#, '0', #AWARD_NUMBER#
FROM   DUAL
WHERE  ROWNUM < 2
<if AWARD_TYPE==4>
AND NOT EXISTS (
    SELECT R2.LOG_ID
    FROM   TF_B_AWARD_ORDER R2
    WHERE  R2.AWARD_TYPE = '4'
    AND    R2.CUST_ID = #CUST_ID#
    AND    TRUNC(R2.CREATE_TIME) = TRUNC(SYSDATE)
)
<else>
AND NOT EXISTS (
    SELECT R2.LOG_ID
    FROM   TF_B_AWARD_ORDER R2
    WHERE  R2.AWARD_TYPE IN ('1', '2', '3')
    AND    R2.CUST_ID = #CUST_ID#
)
<end>
    
-- 随机获取一条卡信息
[GetRandomCardInfo]
SELECT * FROM (
    SELECT /*+ FRIST_ROWS(10) */ DBMS_RANDOM.VALUE(1,10) RANDOM,
           C.CARD_NO, C.CARD_MONEY, C.CARD_STATUS
    FROM  TF_R_AWARD_CARD C
    WHERE C.CARD_MONEY = #CARD_MONEY#
    AND   C.CARD_STATUS = '1'
    ORDER BY 1
) WHERE ROWNUM <= 1

    
-- 为当前卡加行级锁
[RowLockCardInfo]
SELECT C.* 
FROM   TF_R_AWARD_CARD C 
WHERE  C.CARD_NO = #CARD_NO# 
FOR UPDATE

    
-- 更新卡状态
[UpdateCardStatus]
UPDATE TF_R_AWARD_CARD C
SET    C.CARD_STATUS = '0',
       C.OUT_TM = SYSDATE
WHERE  C.CARD_NO = #CARD_NO#
AND    C.CARD_STATUS = '1'

    
-- 统计抽奖信息
[StatisticAwardOrder]
SELECT COUNT(R.LOG_ID)
FROM   TF_B_AWARD_ORDER R
WHERE 
<switch StatisticDimens>
<case CustIp>
	AND    R.CUST_IP = #CUST_IP#
	AND    TRUNC(R.CREATE_TIME) = TRUNC(SYSDATE)
<case CustId>
	AND    R.CUST_ID = #CUST_ID#
	AND    TRUNC(R.CREATE_TIME) = TRUNC(SYSDATE)
<case JoinAward>
        AND    R.CUST_ID = #CUST_ID#
        AND    R.AWARD_TYPE = '4'
        AND    TRUNC(R.CREATE_TIME) = TRUNC(SYSDATE)
<case NomalAward>
        AND    R.CUST_ID = #CUST_ID#
        AND    R.AWARD_TYPE IN ('1', '2', '3')
<end>

